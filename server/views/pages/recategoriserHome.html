{% extends "../partials/layout.html" %}

{% from "button/macro.njk" import govukButton %}
{% from "tag/macro.njk" import govukTag %}
{% from "../macros/breadCrumb.html" import breadCrumb %}
{% from "tag/macro.njk" import govukTag %}
{% from "details/macro.njk" import govukDetails %}
{% from "checkboxes/macro.njk" import govukCheckboxes %}
{% from "button/macro.njk" import govukButton %}
{%- from "moj/components/filter/macro.njk" import mojFilter -%}

{% set pageTitle = "Category reviews for prisoners" %}

{% block beforeContent %}

{{ breadCrumb(breadCrumbList) }}

{% endblock %}

{% block content %}

<div >
  <h1 class="govuk-heading-l">{{ pageTitle }}</h1>
</div>

<div class="govuk-tabs" data-module="govuk-tabs-disabled">

  <ul class="govuk-tabs__list">
    <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
      <a class="govuk-tabs__tab" id="todo-tab">
        Category reviews
      </a>
    </li>
    <li class="govuk-tabs__list-item">
      <a class="govuk-tabs__tab" id="check-tab" href="/recategoriserCheck">
        Potential reviews{% if riskChangeCount > 0 %}<div class="tabTotal"><span class="adjustCount">{{ riskChangeCount }}</span></div>{% endif %}
      </a>
    </li>
    <li class="govuk-tabs__list-item">
      <a class="govuk-tabs__tab" id="done-tab" href="/recategoriserDone">
        Finished reviews
      </a>
    </li>
  </ul>

  <section class="govuk-tabs__panel">

  <div class="filterable-table-container">
    {% if showRecategorisationPrioritisationFilter %}
      {% set filterContainerClass = 'govuk-visually-hidden' if hideRecategoriserHomeFilter else '' %}
      <div id="filterContainer" class="side-filter filterable-table-filter-container govuk-!-padding-right-0 {{ filterContainerClass }}">
        <form method="get">
          {%- set filterOptionsHtml %}
            {% for key, filterNames in allFilters %}
              {% set filterCheckboxes = [] %}
              {% for filterKey, displayName in allFilters[key] %}
                {% set filterCheckboxes = (filterCheckboxes.push({
                value: filterKey,
                text: displayName,
                checked:  filterKey in filters[key] if filters[key] else false,
                attributes: { 'data-qa': filterKey + '_checkbox' }
                }), filterCheckboxes) %}
              {% endfor %}
              <div class="govuk-heading-m">
                {{ filterKeys[key] }}
              </div>
              {% if key == 'suitabilityForOpenConditions' %}
                <div class="filterInfoBox">
                  Filter the category reviews list to see prisoners who may be suitable to move to open conditions.
                </div>
                <div
                  id="selectAllSuitabilityForOpenConditionsFilter"
                  class="linkStyledButton govuk-!-font-size-16 govuk-!-margin-bottom-3"
                >
                  {{ 'Select all' if filters.suitabilityForOpenConditions|length < allFilters.suitabilityForOpenConditions|length else 'Deselect all' }}
                </div>
              {% endif %}
              {{ govukCheckboxes({
                name: key + '[]',
                classes: "govuk-checkboxes--small",
                fieldset: {
                  legend: {
                    text: "Filter based on " + filterKeys[key],
                    classes: "govuk-visually-hidden"
                  }
                },
                items: filterCheckboxes
              }) }}

            {% endfor %}

            <div class="replacementApplyFilterButtonContainer">
              {{ govukButton({
                id: 'applyFilters',
                type: 'submit',
                text: "Apply filters",
                classes: "govuk-!-margin-top-3"
              }) }}
            </div>
          {% endset -%}

          {% set filterCategories = [] %}
          {% for key, filterNames in filters %}
            {% set selectedItems = [] %}
            {% for filter in filterNames %}
              {% set selectedItems = (selectedItems.push({
                href: removeFilterFromFullUrl(filter, key, fullUrl, numberOfFiltersApplied),
                text: allFilters[key][filter]
              }), selectedItems) %}
            {% endfor %}

            {% set filterCategories = (filterCategories.push({
              heading: {
                text: filterKeys[key]
              },
              items: selectedItems
            }), filterCategories) %}
          {% endfor %}

          {{ mojFilter({
            heading: {
              text: 'Filter'
            },
            selectedFilters: {
              heading: {
                text: 'Selected filters'
              },
              clearLink: {
                text: 'Clear filters',
                href: '/recategoriserHome'
              },
              categories: filterCategories
            } if filterCategories.length > 0,
            optionsHtml: filterOptionsHtml
          }) }}
        </form>
      </div>
    {% endif %}

    {% set tableContainerClass = 'filterable-table-body-container' if showRecategorisationPrioritisationFilter and not hideRecategoriserHomeFilter else 'govuk-grid-column-full govuk-!-padding-0' %}

    <div id="tableContainer" class="{{ tableContainerClass }}">
      {% if showRecategorisationPrioritisationFilter %}
        <div class="filterControls">
          <div>
            {{ govukButton({
              id: "hideFilterButton",
              text: "Show filter" if hideRecategoriserHomeFilter else "Hide filter",
              classes: "govuk-button--secondary govuk-!-margin-bottom-0"
            }) }}
          </div>
          <div class="govuk-!-margin-left-2">You have <b>{{ numberOfFiltersApplied }}</b> filter{{ 's' if numberOfFiltersApplied != 1 }} applied</div>
        </div>
      {% endif %}
      {% if offenders | length > 0 %}
      <div class="recategorisation-scrollable-pane">
        <table class="govuk-table tablesorter sortcolumns recategorisation-table" id="offenderTable">
          <thead class="govuk-table__head">

          <tr class="govuk-table__row">
            <th class="govuk-table__header" scope="col">Due date</th>
            <th class="govuk-table__header" scope="col">Name</th>
            <th class="govuk-table__header" scope="col">Prison no</th>
            <th class="govuk-table__header" scope="col">Reason for review</th>
            <th class="govuk-table__header" scope="col">Status</th>
            <th class="govuk-table__header" scope="col">POM</th>
            <th class="govuk-table__header" scope="col"></th>
          </tr>
          </thead>
          <tbody class="govuk-table__body">
          {% for row in offenders %}
          <tr class="govuk-table__row ">
            <td class="govuk-table__cell">
              {% if row.overdue %}
                {{ govukTag({
                  text: 'Overdue',
                  classes: 'govuk-tag--red',
                  attributes: { 'title': 'Due date: ' + row.nextReviewDateDisplay }
                }) }}
              {% else %}
                {{ row.nextReviewDateDisplay }}
              {% endif %}
            </td>
            <td class="govuk-table__cell"><a class="govuk-!-text-break-word" target="_blank" href="{{ row.offenderNo | offenderLink }}">{{ row.displayName }}</a>
              {% if row.securityReferred %}
                {{ govukDetails({
                summaryText: 'Security referred',
                text: 'Security have flagged this person as being of interest. They will be automatically referred to security when the categorisation starts.',
                classes: 'govuk-body govuk-!-font-size-14 govuk-!-margin-bottom-0'
                }) }}
              {% endif %}
            </td>
            <td class="govuk-table__cell">{{ row.offenderNo }}</td>
            <td class="govuk-table__cell recategorisation-reason-for-review-column">{{ row.reason.value }}</td>
            <td class="govuk-table__cell">
              {% if row.displayStatus == 'Back from Supervisor' %}
                {{ govukTag({
                  html: 'Rejected by<br/>supervisor'
                }) }}
              {% else %}
                {{ row.displayStatus }}
              {% endif %}
            </td>
            <td class="govuk-table__cell govuk-!-text-break-word">{{ row.pom }}</td>
            <td class="govuk-table__cell govuk-!-margin-top-2 govuk-!-margin-bottom-8">
              {% set basicClasses = "tableButton govuk-!-padding-left-3 govuk-!-padding-right-3" %}
              {% set href = ("/form/awaitingApprovalView/" + row.bookingId) if row.displayStatus == 'Awaiting approval'
                       else ("/tasklistRecat/" + row.bookingId + '?reason=' + row.reason.name) %}
              {% set classes = basicClasses if row.buttonText == 'Start' else basicClasses + " grey-button" %}
              {% if row.pnomis %}
                <div class="govuk-!-margin-bottom-1 govuk-!-margin-top-1">{{ row.pnomis }}</div>
              {% else %}
                {{ govukButton({
                  text: row.buttonText,
                  href: href if not locked,
                  attributes: { 'data-prevent-double-click': 'true' },
                  classes: classes
                }) }}
              {% endif %}
            </td>
          </tr>
          {% endfor %}

          </tbody>
        </table>
      </div>
      {% else %}
        <div class="govuk-!-padding-top-4">
          {% if filters|length %}
            <div id="no-results-due-to-filters-message">
              <h3 class="govuk-heading-s">There are no prisoners matching the selected filters.</h3>
              <div>Try removing filters to show more prisoners.</div>
            </div>
          {% else %}
            <div id="no-results-message">
              <h3 class="govuk-heading-s">There are no outstanding category reviews to show.</h3>
            </div>
          {% endif %}
        </div>
      {% endif %}
      </div>
    </div>
  </section>
</div>

{% endblock %}

{% block bodyEnd %}
  {{ super() }}
  {% if showRecategorisationPrioritisationFilter %}
    <meta name="csrf-token" content="{{ csrfToken }}">
    <script type="module" src="/assets/js/recategoriserHome.js"></script>
  {% endif %}
{% endblock %}

{% extends "../partials/layout.html" %}
{% from "button/macro.njk" import govukButton %}
{% from "back-link/macro.njk" import govukBackLink %}

{% block beforeContent %}

{{ govukBackLink({
text: "Back",
href: backLink or "/"
}) }}

{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <h1 class="govuk-heading-l">Categorisation task list</h1>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <h1 class="govuk-heading-m">Offender details</h1>
    </div>
  </div>

  {% include "../partials/offenderDetails.html" %}
  <hr/>

  {% set offendingHistoryCompleted = data.ratings.offendingHistory.previousConvictions and data.ratings.offendingHistory.furtherCharges %}
  {% set locked = data.status === Status.SECURITY_MANUAL.name or data.status === Status.SECURITY_AUTO.name %}
  {% set securityInputCompleted = (data.ratings.securityInput.securityInputNeeded === 'No') or data.ratings.securityBack.catB %}
  {% set violenceRatingCompleted = data.ratings.violenceRating.highRiskOfViolence and data.ratings.violenceRating.seriousThreat %}
  {% set escapeRatingCompleted = data.ratings.escapeRating.escapeOtherEvidence %}
  {% set extremismRatingCompleted = data.ratings.extremismRating.previousTerrorismOffences %}
  {% set allSectionsCompleted = offendingHistoryCompleted and securityInputCompleted and not locked and violenceRatingCompleted and escapeRatingCompleted and extremismRatingCompleted %}
  {% set buttonClassesDefault = "govuk-button tableButton app-task-list__task-completed" %}
  <div class="govuk-grid-row govuk-!-width-two-thirds">
    <div class="govuk-grid-column-full">
      <ul class="app-task-list">
        <li>
          <ul class="app-task-list__items">
            <li class="app-task-list__item">
              {% set buttonTextOH = "Edit" if offendingHistoryCompleted else "Start" %}
              {% set buttonClasses = buttonClassesDefault + " grey-button" if offendingHistoryCompleted else buttonClassesDefault %}
                {{ govukButton({
                text: buttonTextOH,
                href: "/form/ratings/offendingHistory/" + data.details.bookingId,
                classes: buttonClasses,
                attributes:
                {  'id': 'offendingHistoryButton' }
                }) }}
                <div class="govuk-heading-m">Offending history</div>
                <div class="govuk-!-margin-top-2">{% if offendingHistoryCompleted %}Completed{% else %}Not yet checked{% endif %}</div>
            </li>
            <li class="app-task-list__item">
              {% set buttonTextV = "Edit" if violenceRatingCompleted else "Start" %}
              {% set buttonClasses = buttonClassesDefault + " grey-button" if violenceRatingCompleted else buttonClassesDefault %}
                {{ govukButton({
                text: buttonTextV,
                href: "/form/ratings/violenceRating/" + data.details.bookingId,
                classes: buttonClasses,
                attributes:
                  {  'id': 'violenceButton' }
                }) }}
                <div class="govuk-heading-m">Safety and good order</div>
                <div class="govuk-!-margin-top-2">{% if violenceRatingCompleted %}Completed{% else %}Not yet checked{% endif %}</div>
            </li>
            <li class="app-task-list__item ">
              {% set buttonTextE = "Edit" if escapeRatingCompleted else "Start" %}
              {% set buttonClasses = buttonClassesDefault + " grey-button" if escapeRatingCompleted else buttonClassesDefault %}
                {{ govukButton({
                text: buttonTextE,
                href: "/form/ratings/escapeRating/" + data.details.bookingId,
                classes: buttonClasses,
                attributes:
                  {  'id': 'escapeButton' }
                }) }}
                <div class="govuk-heading-m">Risk of escape</div>
                <div class="govuk-!-margin-top-2">{% if escapeRatingCompleted %}Completed{% else %}Not yet checked{% endif %}</div>
            </li>
            <li class="app-task-list__item">
              {% set buttonTextEx = "Edit" if extremismRatingCompleted else "Start" %}
              {% set buttonClasses = buttonClassesDefault + " grey-button" if extremismRatingCompleted else buttonClassesDefault %}
              {{ govukButton({
                text: buttonTextEx,
                href: "/form/ratings/extremismRating/" + data.details.bookingId,
                classes: buttonClasses,
                attributes:
                  {  'id': 'extremismButton' }
              }) }}
              <div class="govuk-heading-m">Extremism</div>
              <div class="govuk-!-margin-top-2">{% if extremismRatingCompleted %}Completed{% else %}Not yet checked{% endif %}</div>
            </li>
            <li class="app-task-list__item" id="securitySection">
              {% set backFromSecurity = (data.status === 'SECURITY_BACK' or data.status === 'APPROVED' or data.status === 'AWAITING_APPROVAL') %}
              {% set buttonTextSec = "Edit" if securityInputCompleted else "Start" %}
              {% set buttonClasses = buttonClassesDefault + " grey-button" if securityInputCompleted else buttonClassesDefault %}
              {{ govukButton({
                text: buttonTextSec,
                href: null if locked else ("/form/ratings/securityBack/" + data.details.bookingId if backFromSecurity else "/form/ratings/securityInput/" + data.details.bookingId),
                disabled: locked,
                classes: buttonClasses,
                attributes:
                  { 'id': 'securityButton' }
                })
              }}
              <div class="govuk-heading-m">Security information</div>
              <div class="govuk-!-margin-top-2">{% if locked or backFromSecurity %}{{Status[data.status].value + ' (' + data.referredDate + ')'}}{% elseif securityInputCompleted %}Completed{% else %}Not yet checked{% endif %}</div>
            </li>
            <li id="review" class="app-task-list__item">
              {% set completionText = "Completed" if allSectionsCompleted else "Tasks not yet complete" %}
                {{ govukButton({
                  text: "Continue",
                  href: "/form/categoriser/review/" + data.details.bookingId if allSectionsCompleted,
                  disabled: not allSectionsCompleted,
                  classes: "govuk-button tableButton app-task-list__task-completed"
                }) }}
                <div class="govuk-heading-m">Review and categorisation</div>
                <div class="govuk-!-margin-top-2">{{ completionText }}</div>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
{% endblock %}
